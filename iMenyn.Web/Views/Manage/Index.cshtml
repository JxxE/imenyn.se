@using iMenyn.Data.Helpers
@model iMenyn.Web.ViewModels.EnterpriseViewModel

@{
    ViewBag.Title = "Bidra med en meny";
    var categories = GeneralHelper.GetCategories();
    var hasCoordinates = Model.Coordinates != null;
}

<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.12.0/jquery.validate.min.js"></script>

<style>
    #map {
        height: 280px;
        width: 100%;
        position: relative;
    }
</style>
<h3>Skapa meny</h3>
<p>Här kan du skapa en meny till en resturang. Innan den publiceras kommer den att godkännas av oss.</p>

<div id="step-1">
    <h3 class="grey"><span class="glyphicon glyphicon-info-sign"></span>Om restaurangen</h3>
    @using (Html.BeginForm("Index", "Manage", FormMethod.Post, new { @class = "form-horizontal", id = "enterprise-form" }))
    {

        <div class="form-group">
            @Html.LabelFor(m => m.Name, "Namn", new { @class = "col-sm-2 control-label" })
            <div class="col-sm-4">
                @Html.TextBoxFor(m => m.Name, new { @class = "form-control" })
            </div>
        </div>

        <div class="form-group">
            @Html.LabelFor(m => m.Phone, "Telefon", new { @class = "col-sm-2 control-label" })
            <div class="col-sm-4">
                @Html.TextBoxFor(m => m.Phone, new { @class = "form-control" })
            </div>
        </div>
    


        <div class="form-group">
            <label class="col-sm-2 control-label">Typ</label>
            <div class="col-sm-4">
                <select id="category-chooser" class="form-control@((Model.ChosenCategories != null && Model.ChosenCategories.Count > 4) ? " hide" : "")">
                    <option></option>
                    @foreach (var category in categories)
                    {

                        <option value="@category.Value">@category.Text</option>    
                    }
                </select>
                <div id="chosen-categories" class="form-inline marginB20">
                    @if (Model.ChosenCategories != null)
                    {
                        for (var i = 0; i < Model.ChosenCategories.Count; i++)
                        {
                        <div id="tag-@i" class="tag">@Model.ChosenCategories[i].Text
                            @Html.HiddenFor(m => m.ChosenCategories[i].Value)
                            <span class='glyphicon glyphicon-remove'></span>
                        </div>
                        }
                    }
                </div>
            </div>
        </div>
    
        
        <hr />
        <h3 class="grey"><span class="glyphicon glyphicon-map-marker"></span>Plats</h3>
        <div class="form-group">
            <label for="address-search" class="col-sm-2 control-label">Sök</label>
            <div class="col-sm-4">
                <input type="text" name="address-search" id="address-search" placeholder="Adress" class="form-control">
            </div>
        </div>

        <div class="form-group">
            <label class="col-sm-2"></label>
            <div class="col-sm-4">
                <a id="my-location" href="javascript:void(0)" class="btn btn-info">Markera på karta<span class="glyphicon glyphicon-screenshot"></span></a>
            </div>
        </div>

        <div id="location-details" class="well @(string.IsNullOrEmpty(Model.Name) ? "hide" : "")">
            <div class="row">
                <div class="col-sm-4">
                    <div class="form-group">
                        @* Gatuadress *@
                        @Html.LabelFor(m => m.StreetRoute, "Gatuadress", new { @class = "col-sm-4 control-label" })
                        <div class="col-sm-8">
                            @Html.TextBoxFor(m => m.StreetRoute, new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group">
                        @* Gatunummer  *@
                        @Html.LabelFor(m => m.StreetNumber, "Gatunummer ", new { @class = "col-sm-4 control-label" })
                        <div class="col-sm-3">
                            @Html.TextBoxFor(m => m.StreetNumber, new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group">
                        @* Postnummer  *@
                        @Html.LabelFor(m => m.PostalCode, "Postnummer ", new { @class = "col-sm-4 control-label" })
                        <div class="col-sm-4">
                            @Html.TextBoxFor(m => m.PostalCode, new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group">
                        @* Postort  *@
                        @Html.LabelFor(m => m.PostalTown, "Postort ", new { @class = "col-sm-4 control-label" })
                        <div class="col-sm-8">
                            @Html.TextBoxFor(m => m.PostalTown, new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group">
                        @* Kommun  *@
                        @Html.LabelFor(m => m.Commune, "Kommun ", new { @class = "col-sm-4 control-label" })
                        <div class="col-sm-8">
                            @Html.TextBoxFor(m => m.Commune, new { @class = "form-control" })
                        </div>
                    </div>
                    <div class="form-group">
                        @* Län  *@
                        @Html.LabelFor(m => m.County, "Län ", new { @class = "col-sm-4 control-label" })
                        <div class="col-sm-8">
                            @Html.TextBoxFor(m => m.County, new { @class = "form-control" })
                        </div>
                    </div>
                </div>
                @Html.TextBoxFor(m => m.Nope, new { @class = "hide" })
                @Html.HiddenFor(m => m.CountryCode)
                @Html.HiddenFor(m => m.SubLocality)
                @Html.HiddenFor(m => m.Coordinates.Lat)
                @Html.HiddenFor(m => m.Coordinates.Lng)
                @Html.HiddenFor(m => m.EditKey)

                <div class="col-sm-8">
                    <div id="map"></div>
                </div>
            </div>

        </div>
    
    }
</div>

<div id="step-2" class="hide">
    <div class="well">
        <h1>Här skapar man menyn</h1>
    </div>
</div>


<div id="steps-navigation" data-length="2">
    <small>Steg <span data-step="current"></span> av <span data-step="total"></span></small>
    <div>
        <a id="prev-step" href="javascript:void(0)" class="btn btn-info hide"><span class="glyphicon glyphicon-chevron-left"></span>Tillbaka</a>
        <a id="next-step" href="javascript:void(0)" class="btn btn-success">Nästa <span class="glyphicon glyphicon-chevron-right"></span></a>
    </div>
</div>

<script>
    $(document).ready(function () {
        if (window.location.hash) {
            iMenyn.Utilities.ShowStep(window.location.hash.replace("#", ""));
        }
        if ('@hasCoordinates' === 'True') {
            setMap('@(Model.Coordinates != null ? Model.Coordinates.Lat : null)', '@(Model.Coordinates != null ? Model.Coordinates.Lng : null)');
        }
    });
    
    //Initiate category chooser
    iMenyn.Utilities.InitCategoryChooser();

    $("#next-step").click(function () {
        var enterpriseForm = $("#enterprise-form").serialize();
        iMenyn.Ajax.CreateTempEnterprise(enterpriseForm);
    });
    
    $("#prev-step").click(function () {
        iMenyn.Utilities.ShowStep(1);
    });

    $("#my-location").click(function () {
        iMenyn.Utilities.MyLocation(function (data) {
            var lat, lng;
            if (data) {
                //My location
                lat = data.latitude;
                lng = data.longitude;
            }
            else {
                //Stockholm
                lat = '59.332362';
                lng = '18.065109';
            }
            setMap(lat, lng);
            geocodePosition(lat, lng);
        });
    });


    var componentForm = {
        street_number: 'StreetNumber', // Gatunummer: 2A
        route: 'StreetRoute', // Gata: Ringvägen
        administrative_area_level_1: 'County', // Län: Stockholms län, Södermanlands län
        administrative_area_level_2: 'Commune', // Kommun: Botkyrka, Strängnäs
        country: 'CountryCode', // Land: SE
        postal_code: 'PostalCode', // Postnummer: 14770
        postal_town: 'PostalTown', // Postort: Mariefred, Grödinge, Stockholm,
        sublocality: 'SubLocality' // Osäker. Södermalm är en iaf.        
    };

    function initialize() {
        var locationSearchBox = (document.getElementById('address-search'));
        var autocomplete = new google.maps.places.Autocomplete(locationSearchBox);
        autocomplete.setComponentRestrictions({ "country": "se" });
        autocomplete.setTypes(['geocode']);

        google.maps.event.addListener(autocomplete, 'place_changed', function () {

            //Töm alla textboxar
            clearAllBoxes();

            var place = autocomplete.getPlace();

            getAddressComponents(place);

            //Visa karta
            setMap(place.geometry.location.k, place.geometry.location.A);

        });

    }


    function getAddressComponents(place) {
        for (var i = 0; i < place.address_components.length; i++) {
            var addressType = place.address_components[i].types[0];
            if (componentForm[addressType]) {
                var val = place.address_components[i]['short_name'];
                if (addressType === 'administrative_area_level_1')
                    val = val.replace(" County", "");// Ta bort "County" från resultatet
                document.getElementById(componentForm[addressType]).value = val;
            }
        }

        //Lägg ut koordinaterna o dolda textboxarna
        document.getElementById('Coordinates_Lat').value = place.geometry.location.k;
        document.getElementById('Coordinates_Lng').value = place.geometry.location.A;

    }

    var mapMarker;
    function setMap(lat, lng) {
        //Ta bort klassen "hide"
        $("#location-details").removeClass("hide");

        var lngLat = new google.maps.LatLng(lat, lng);
        var mapOptions = {
            zoom: 13,
            center: lngLat
        };

        var map = new google.maps.Map(document.getElementById('map'), mapOptions);

        mapMarker = new google.maps.Marker({
            position: lngLat,
            map: map,
            draggable: true,
            animation: google.maps.Animation.DROP
        });
        mapMarker.setMap(map);

        google.maps.event.addListener(mapMarker, 'dragend', function () {
            var pos = mapMarker.getPosition();
            geocodePosition(pos.k, pos.A);
        });

    }

    function geocodePosition(lat, lng) {
        var geocoder = new google.maps.Geocoder();

        geocoder.geocode
        ({
                latLng: new google.maps.LatLng(lat, lng)
            },
            function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    getAddressComponents(results[0]);
                }
                else {

                }
            }
        );
    }

    function clearAllBoxes() {
        for (var input in componentForm) {
            document.getElementById(componentForm[input]).value = "";
        }
    }

    google.maps.event.addDomListener(window, 'load', initialize);

//TODO, validate
    //$("#enterprise-form").validate({
    //    rules: {
    //        PostalCode: {
    //            number: true,
    //            required: true,
    //            rangelength: [5, 5]
    //        },
    //        Name: { required: true }
    //    },
    //    messages: {
    //        PostalCode: {
    //            number: "Får endast innehålla siffor",
    //            required: "Ange ett postnummer",
    //            rangelength: "Postnummer ska vara femsiffrigt."
    //        },
    //        Name: { required: "Ange restaurangens namn" }
    //    },
    //    submitHandler: function (form) {
    //        var chosenCategoriesCount = $("#chosen-categories").children('div').size();
    //        if (chosenCategoriesCount == 0) {
    //            $("<p class='error'>Välj minst 1 kategori!</p>").insertAfter("div[data-id='chosen-categories']");
    //        }
    //        else {
    //            form.submit();
    //        }
    //    }
    //});
</script>

<noscript>
    <style>
        form {display: none;}
    </style>
    <h1>Aktivera JavaScript för att se sidan</h1>
</noscript>
@model iMenyn.Data.ViewModels.CompleteEnterpriseViewModel
<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script scr="//cdnjs.cloudflare.com/ajax/libs/knockout/3.1.0/knockout-min.js"></script>
@{
    ViewBag.Title = "Demomeny";
}
<h1>a: @HttpContext.Current.User.Identity.Name</h1>
<div class="row">
    <div class="col-sm-8 edit">
        @Model.Name
        <div class="row">
            <div class="col-sm-12">
                <a class="dynamic-add btn btn-info" data-before="false" href="@Url.Action("BlankCategory","Manage",new{enterpriseId = Model.Id })">Lägg till kategori<span class="glyphicon glyphicon glyphicon-plus"></span></a>
                <a href="javascript:void(0)" data-action="toggleclass" data-class="sorting-categories" class="btn btn-warning">Sortera kategorier<span class="glyphicon glyphicon-sort"></span></a>
            </div>
        </div>
        @foreach (var category in Model.ViewModelCategories)
        {
            @Html.Partial("_Category", category)
        }
        
    </div>
    <div class="row">
        <div class="col-sm-10 col-sm-offset-1">
            <a id="save-menu-setup" href="javascript:void(0)" class="btn btn-success">Spara & avsluta<span class="glyphicon glyphicon-ok"></span></a>
        </div>
    </div>
</div>

<script>   
    $(document).on('click', '.product-prices-edit .glyphicon', (function () {
        $(this).closest('.form-group').remove();
    }));
    
    $(document).on('click', '.dynamic-add', (function () {
        var $this = $(this);
        var before = true;
        var maxOccurs = 0;
        var maxType = undefined;
        var maxParent = undefined;
        
        if ($this.data('before') != undefined && $this.data('before').toString() == "false") {
            before = false;
        }
        if ($this.data('max') != undefined) {
            maxOccurs = $this.data('max');
            maxParent = $(this).parent();
            maxType = 'div';
        }
        var status = iMenyn.Utilities.DynamicAdd({ href: this.href, senderObj: $this, before: before, maxOccurs: maxOccurs, maxParent: maxParent, maxType: maxType });
            
        return false;
    }));

    $(document).on('click', '.glyphicon-pencil', (function () {
        var $this = $(this);
        var editForm = $this.closest('form');
        var editModeClass = 'edit-mode';
        var removeClass = 'glyphicon-remove';

        //Hide all opened edit-forms
        $('.form-product.edit-mode').not(editForm).removeClass(editModeClass);
        $('.glyphicon-pencil.glyphicon-remove').not($this).removeClass(removeClass);

        //Toggle active classes
        editForm.toggleClass(editModeClass);
        $this.toggleClass(removeClass);
    }));
    
    $(document).on('click', '.delete-product', (function () {
        var editForm = $(this).closest('form');
        editForm.remove();
    }));
    
    $(".category").sortable({ items: "form", handle: ".glyphicon-resize-vertical", connectWith:".category" });
    $("#main-container").sortable({ items: ".category", handle: ".glyphicon-resize-vertical" });

    $("#save-menu-setup").click(function () {
        var $categories = $(".category");
        var setup = new Object();
        setup.Categories = new Array();
        for (var i = 0; i < $categories.length; i++) {
            var $category = $($categories[i]);
            var category = new Object();
            category.id = $category.data('category');
            category.name = $category.find('.category-name').html();
            category.products = new Array();
            var products = $category.children().find('.product');
            for (var j = 0; j < products.length; j++) {
                var productId = $(products[j]).find("input[name='Id']").val();
                if (productId)
                    category.products.push(productId);
            }
            setup.Categories.push({ Id: category.id, Name: category.name, Products: category.products });
        }
        console.log(setup)
        iMenyn.Ajax.SaveMenuSetup(JSON.stringify(setup), '@Model.Id');
    });

    $(document).on('submit', '.form-product', (function () {
        var formData = $(this).serialize();
        iMenyn.Ajax.SaveProduct($(this), formData);
        return false;
    }));

    $("#test").submit(function () {
        //var formData = $(this).serialize();
        //iMenyn.Ajax.SaveProduct(formData);
        // var a = '{ "prices":{"Name":"namn","ViewModelCategories.index":["6a9488b7-f803-4192-8f4f-f640f944e89e","8a9488b7-f803-4192-8f4f-f640f944e89e"],"ViewModelCategories":[{"ViewModelCategories[6a9488b7-f803-4192-8f4f-f640f944e89e].Name":"asd"},{"ViewModelCategories[8a9488b7-f803-4192-8f4f-f640f944e89e].Name":"TJA"}]}     }';
        // //var a = '{ "prices":{"Name":"namn","ViewModelCategories.index":["6a9488b7-f803-4192-8f4f-f640f944e89e","8a9488b7-f803-4192-8f4f-f640f944e89e"],"ViewModelCategories[6a9488b7-f803-4192-8f4f-f640f944e89e].Name":"asd"},{"ViewModelCategories[8a9488b7-f803-4192-8f4f-f640f944e89e].Name":"TJA"}}     }';
        // var formData = JSON.stringify($(this).serializeObject());
        // var j = '{ "prices": ' + formData + '}';
        //console.log(a)
        // $.ajax({
        //     data: a,
        //     dataType: "json",
        //     contentType: "application/json; charset=utf-8",
        //     url: '/Manage/T/',
        //     type: "POST"
        // });
        // return false;
    });


    $.fn.serializeObject = function () {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function () {
            if (o[this.name]) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    };
</script>
